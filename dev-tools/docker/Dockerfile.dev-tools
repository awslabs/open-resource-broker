# Development tools container with security hardening

ARG PYTHON_VERSION=3.13
ARG PACKAGE_NAME_SHORT=orb

FROM python:${PYTHON_VERSION}-slim

# Re-declare build arguments for this stage
ARG PACKAGE_NAME_SHORT
ARG BUILD_DATE
ARG VERSION=dev
ARG VCS_REF
ARG AUTHOR
ARG LICENSE

# Add metadata labels
LABEL org.opencontainers.image.title="Open Resource Broker Dev Tools" \
      org.opencontainers.image.description="Development and CI tools for Open Resource Broker" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="${AUTHOR}" \
      org.opencontainers.image.licenses="${LICENSE}"

# Install system dependencies and create user in single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl=8.14.1-2 \
    ca-certificates=20250419 \
    build-essential=12.12 \
    git=1:2.47.2-0.2 \
    make=4.4.1-2 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && groupadd -r "${PACKAGE_NAME_SHORT}" \
    && useradd -r -g "${PACKAGE_NAME_SHORT}" -s /bin/false "${PACKAGE_NAME_SHORT}"

# Install UV (pinned version for consistency)
RUN pip install --no-cache-dir uv==0.8.11

# Set working directory and create directories
WORKDIR /app
RUN mkdir -p /app/logs /app/data /app/tmp

# Copy project files needed for dev tools installation
COPY pyproject.toml ./
COPY Makefile ./
COPY dev-tools/ ./dev-tools/

# Install development tools using makefile targets
RUN make install-dev-tools-required
COPY uv.lock ./
COPY README.md ./
COPY src/ ./src/

# Install all dev and ci dependencies with uv (uses versions from uv.lock)
RUN uv sync --group dev --group ci

# Set permissions
RUN chown -R "${PACKAGE_NAME_SHORT}":"${PACKAGE_NAME_SHORT}" /app

# Set environment variables
ENV PYTHONPATH=/app \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=utf-8

# Switch to non-root user
USER "${PACKAGE_NAME_SHORT}"

# Default command
CMD ["bash"]
