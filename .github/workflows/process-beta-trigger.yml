name: Process Beta Release Trigger

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-beta:
    name: Create Beta Release
    runs-on: ubuntu-latest
    if: |
      github.event.issue.state == 'open' &&
      contains(github.event.comment.body, '/release-beta') &&
      contains(github.event.issue.labels.*.name, 'beta') &&
      contains(github.event.issue.labels.*.name, 'weekly')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history for release
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: '3.11'

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add reaction to comment
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='rocket'

      - name: Create beta release
        id: release
        run: |
          # Commit any generated files before release creation
          if ! git diff-index --quiet HEAD --; then
            git add .
            git commit -m "chore: update generated files for release"
          fi
          
          echo "Creating beta release..."
          make promote-beta
          
          # Get the created release info
          LATEST_TAG=$(git tag -l "v*beta*" --sort=-version:refname | head -1)
          echo "release_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on issue with success
        if: success()
        run: |
          cat > success_comment.md << 'EOF'
          Beta release RELEASE_TAG_PLACEHOLDER created successfully!

          Release: https://github.com/REPOSITORY_PLACEHOLDER/releases/tag/RELEASE_TAG_PLACEHOLDER
          Changelog PR: Will be created automatically for review and merge.

          This issue will be closed automatically.
          EOF
          
          sed -i "s/RELEASE_TAG_PLACEHOLDER/${{ steps.release.outputs.release_tag }}/g" success_comment.md
          sed -i "s/REPOSITORY_PLACEHOLDER/${{ github.repository }}/g" success_comment.md
          
          gh issue comment ${{ github.event.issue.number }} --body-file success_comment.md

      - name: Comment on issue with failure
        if: failure()
        run: |
          cat > failure_comment.md << 'EOF'
          Failed to create beta release. Please check the workflow logs and try again.

          Workflow: https://github.com/REPOSITORY_PLACEHOLDER/actions/runs/RUN_ID_PLACEHOLDER
          EOF
          
          sed -i "s/REPOSITORY_PLACEHOLDER/${{ github.repository }}/g" failure_comment.md
          sed -i "s/RUN_ID_PLACEHOLDER/${{ github.run_id }}/g" failure_comment.md
          
          gh issue comment ${{ github.event.issue.number }} --body-file failure_comment.md

      - name: Close issue on success
        if: success()
        run: |
          gh issue close ${{ github.event.issue.number }} --comment "Beta release completed successfully. Issue closed automatically."
