name: Container Build and Publish

env:
  # Comment trigger words for container builds
  CONTAINER_TRIGGERS: "/container"

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'src/**'
      - 'pyproject.toml'
      - 'deployment/docker/**'
      - 'dev-tools/scripts/container_build.sh'
      - '.github/workflows/container.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'src/**'
      - 'pyproject.toml'
      - 'deployment/docker/**'
      - 'dev-tools/scripts/container_build.sh'
      - '.github/workflows/container.yml'
  issue_comment:
    types: [created]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: false
        type: boolean

jobs:
  check-container-comment:
    name: Check Container Triggers
    runs-on: ubuntu-latest
    outputs:
      triggered: ${{ steps.check.outputs.triggered }}
      pr_ref: ${{ steps.check.outputs.pr_ref }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check container comment
        id: check
        uses: ./.github/actions/check-comment-trigger
        with:
          triggers: ${{ env.CONTAINER_TRIGGERS }}

  get-config:
    name: Get Configuration
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'issue_comment' || 
      needs.check-container-comment.outputs.triggered == 'true'
    needs: [check-container-comment]
    outputs:
      python-versions: ${{ steps.config.outputs.python-versions }}
      default-python-version: ${{ steps.config.outputs.default-python-version }}
      container-registry: ${{ steps.config.outputs.container-registry }}
      container-image: ${{ steps.config.outputs.container-image }}
      pypi-package-version: ${{ steps.config.outputs.pypi-package-version }}
      container-tag-prefix: ${{ steps.config.outputs.container-tag-prefix }}
      is-release: ${{ steps.config.outputs.is-release }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ needs.check-container-comment.outputs.pr_ref || github.sha }}

    - name: Get project configuration
      id: config
      uses: ./.github/actions/get-config

  container-build:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: [get-config, check-container-comment]
    if: |
      github.event_name != 'issue_comment' || 
      needs.check-container-comment.outputs.triggered == 'true'

    strategy:
      matrix:
        python-version: ${{ fromJSON(needs.get-config.outputs.python-versions) }}

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ needs.check-container-comment.outputs.pr_ref || github.sha }}

    - name: Set versions for matrix job
      run: |
        # Use centralized versions from get-config (DRY approach)
        PYPI_PACKAGE_VERSION="${{ needs.get-config.outputs.pypi-package-version }}"
        CONTAINER_TAG_PREFIX="${{ needs.get-config.outputs.container-tag-prefix }}"
        CONTAINER_URI="${{ needs.get-config.outputs.container-registry }}/${{ needs.get-config.outputs.container-image }}:${{ needs.get-config.outputs.container-tag-prefix }}-python${{ matrix.python-version }}"
        
        if [[ "${{ github.event_name }}" == "release" ]]; then
          # Release: push to registry
          PUSH_IMAGES="true"
          CONTAINER_TAGS="latest,${{ needs.get-config.outputs.pypi-package-version }}"
        elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
          # Main branch: push with dev tags
          PUSH_IMAGES="true"
          CONTAINER_TAGS="dev,$CONTAINER_TAG_PREFIX-python${{ matrix.python-version }}"
        else
          # PR/comment triggers: don't push (security)
          PUSH_IMAGES="false"
          CONTAINER_TAGS="$CONTAINER_TAG_PREFIX-python${{ matrix.python-version }}"
        fi
        
        # Export to environment for subsequent steps
        {
          echo "PYPI_PACKAGE_VERSION=$PYPI_PACKAGE_VERSION"
          echo "CONTAINER_TAG_PREFIX=$CONTAINER_TAG_PREFIX"
          echo "CONTAINER_URI=$CONTAINER_URI"
          echo "PUSH_IMAGES=$PUSH_IMAGES"
          echo "CONTAINER_TAGS=$CONTAINER_TAGS"
        } >> "$GITHUB_ENV"
        
        # Display values for debugging
        echo "PyPI package version: $PYPI_PACKAGE_VERSION"
        echo "Container tag prefix: $CONTAINER_TAG_PREFIX"
        echo "Container URI: $CONTAINER_URI"
        echo "Push images: $PUSH_IMAGES"
        echo "Tags: $CONTAINER_TAGS"

    - name: Setup Python and UV
      uses: ./.github/actions/setup-uv-cached
      with:
        cache-key: deps-${{ matrix.python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml.template', 'requirements*.txt') }}
        fail-on-cache-miss: false

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ needs.get-config.outputs.container-registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build package wheel
      run: |
        make build

    - name: Build container using dev-tools script
      env:
        REGISTRY: ${{ needs.get-config.outputs.container-registry }}
        IMAGE_NAME: ${{ needs.get-config.outputs.container-image }}
        VERSION: ${{ env.PYPI_PACKAGE_VERSION }}
        CONTAINER_TAG_PREFIX: ${{ env.CONTAINER_TAG_PREFIX }}
        PYTHON_VERSION: ${{ matrix.python-version }}
        PLATFORMS: linux/amd64,linux/arm64
        PUSH: ${{ github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event_name == 'release' || github.event.inputs.push_images == 'true') }}
        CACHE: true
        SKIP_BUILD: true
      run: |
        PYTHON_VERSION=${{ matrix.python-version }} make container-build-single

    - name: Test container image
      if: matrix.python-version == needs.get-config.outputs.default-python-version
      env:
        HEALTH_CHECK_TIMEOUT: 90
        HEALTH_CHECK_INTERVAL: 5
      run: |
        # Test that the container starts and responds to health check
        echo "Testing container image: ${{ env.CONTAINER_URI }}"

        # Run container in background
        docker run --rm -d --name test-container \
          -p 8000:8000 \
          "${{ env.CONTAINER_URI }}"

        # Wait for container to start
        echo "Waiting for container to start..."
        sleep 20

        # Test health endpoint using Makefile target with CI timeout
        make container-health-check

        echo "Container test passed!"

        # Stop test container
        docker stop test-container

  container-cleanup:
    name: Cleanup Old Container Images
    runs-on: ubuntu-latest
    needs: [get-config, container-manifest]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event_name == 'release')

    permissions:
      contents: read
      packages: write

    steps:
    - name: Delete old untagged container images (keep 5 most recent)
      uses: actions/delete-package-versions@v5
      continue-on-error: true
      with:
        package-name: ${{ needs.get-config.outputs.container-image }}
        package-type: container
        min-versions-to-keep: 5
        delete-only-untagged-versions: true

    - name: Delete old tagged versions (preserve releases and special tags)
      uses: actions/delete-package-versions@v5
      continue-on-error: true
      with:
        package-name: ${{ needs.get-config.outputs.container-image }}
        package-type: container
        min-versions-to-keep: 5
        ignore-versions: '^(latest|main|dev|develop|v\d+\.\d+\.\d+.*|.*\.dev-[a-f0-9]+(-python\d+\.\d+)?)$'

  container-manifest:
    name: Create Multi-Architecture Manifests
    runs-on: ubuntu-latest
    needs: [get-config, container-build]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event_name == 'release')

    permissions:
      contents: read
      packages: write

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ needs.get-config.outputs.container-registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and push manifests
      env:
        PYTHON_VERSIONS: ${{ join(fromJSON(needs.get-config.outputs.python-versions), ' ') }}
        DEFAULT_PYTHON_VERSION: ${{ needs.get-config.outputs.default-python-version }}
        REGISTRY: ${{ needs.get-config.outputs.container-registry }}
        IMAGE: ${{ needs.get-config.outputs.container-image }}
        PYPI_PACKAGE_VERSION: ${{ needs.get-config.outputs.pypi-package-version }}
        CONTAINER_TAG_PREFIX: ${{ needs.get-config.outputs.container-tag-prefix }}
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          # Create manifest for latest using default Python version
          echo "Creating latest tag from default Python version: $DEFAULT_PYTHON_VERSION"
          docker buildx imagetools create -t "$REGISTRY/$IMAGE:latest" "$REGISTRY/$IMAGE:$CONTAINER_TAG_PREFIX-python$DEFAULT_PYTHON_VERSION"
        fi

        if [ "${{ github.event_name }}" = "release" ]; then
          # Create manifest for release version using default Python version
          echo "Creating release tag $PYPI_PACKAGE_VERSION from default Python version: $DEFAULT_PYTHON_VERSION"
          docker buildx imagetools create -t "$REGISTRY/$IMAGE:$PYPI_PACKAGE_VERSION" "$REGISTRY/$IMAGE:$PYPI_PACKAGE_VERSION-python$DEFAULT_PYTHON_VERSION"
        fi
