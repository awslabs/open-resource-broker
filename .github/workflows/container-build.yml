name: Container Build and Publish

env:
  CONTAINER_TRIGGERS: "/container"

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'src/**'
      - 'pyproject.toml'
      - 'deployment/docker/**'
      - 'dev-tools/scripts/container_build.sh'
      - '.github/workflows/container-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'src/**'
      - 'pyproject.toml'
      - 'deployment/docker/**'
      - 'dev-tools/scripts/container_build.sh'
      - '.github/workflows/container-build.yml'
  issue_comment:
    types: [created]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: false
        type: boolean

jobs:
  config:
    name: Configuration
    uses: ./.github/workflows/shared-config.yml

  calculate-tags:
    name: Calculate Container Tags
    runs-on: ubuntu-latest
    needs: config
    permissions:
      contents: read
    outputs:
      primary-tags: ${{ steps.tags.outputs.primary-tags }}
      python-tags: ${{ steps.tags.outputs.python-tags }}
      precision-tags: ${{ steps.tags.outputs.precision-tags }}
    steps:
    - name: Calculate all container tags
      id: tags
      run: |
        VERSION="${{ needs.config.outputs.package-version }}"
        
        if [[ "${{ github.event_name }}" == "release" ]]; then
          PRIMARY_TAGS="latest,$VERSION"
          PYTHON_TAGS="python3.9,python3.10,python3.11,python3.12,python3.13"
          PRECISION_TAGS="$VERSION-python3.9,$VERSION-python3.10,$VERSION-python3.11,$VERSION-python3.12,$VERSION-python3.13"
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          PRIMARY_TAGS="main,dev"
          PYTHON_TAGS="python3.9,python3.10,python3.11,python3.12,python3.13"
          PRECISION_TAGS=""
        else
          PRIMARY_TAGS=""
          PYTHON_TAGS=""
          PRECISION_TAGS=""
        fi
        
        {
          echo "primary-tags=$PRIMARY_TAGS"
          echo "python-tags=$PYTHON_TAGS"
          echo "precision-tags=$PRECISION_TAGS"
        } >> "$GITHUB_OUTPUT"

  container-build:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: [config, calculate-tags]

    strategy:
      matrix:
        python-version: ${{ fromJSON(needs.config.outputs.python-versions) }}

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6.0.1
      with:
        ref: ${{ github.sha }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ needs.config.outputs.container-registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python and UV
      uses: ./.github/actions/setup-uv-cached
      with:
        cache-key: deps-${{ matrix.python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml', 'requirements*.txt') }}
        fail-on-cache-miss: false

    - name: Build package wheel
      run: make build

    - name: Build and push multi-arch container
      env:
        REGISTRY: ${{ needs.config.outputs.container-registry }}
        IMAGE_NAME: ${{ needs.config.outputs.container-image }}
        VERSION: ${{ needs.config.outputs.package-version }}
        PYTHON_VERSION: ${{ matrix.python-version }}
      run: |
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --build-arg "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          --build-arg "VERSION=$VERSION" \
          --build-arg "VCS_REF=$(git rev-parse --short HEAD)" \
          --build-arg "PYTHON_VERSION=$PYTHON_VERSION" \
          --build-arg PACKAGE_NAME_SHORT=orb \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          --push \
          -t "$REGISTRY/$IMAGE_NAME:$VERSION-python$PYTHON_VERSION" \
          .

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: [config, container-build]

    strategy:
      matrix:
        include:
          - python-version: ${{ fromJSON(needs.config.outputs.python-versions)[0] }}  # Oldest Python
            scan-level: basic
          - python-version: ${{ needs.config.outputs.default-python-version }}  # Default Python
            scan-level: full

    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6.0.1

    - name: Set container URI
      run: |
        CONTAINER_URI="${{ needs.config.outputs.container-registry }}/${{ needs.config.outputs.container-image }}:${{ needs.config.outputs.package-version }}-python${{ matrix.python-version }}"
        echo "CONTAINER_URI=$CONTAINER_URI" >> "$GITHUB_ENV"

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: ${{ env.CONTAINER_URI }}
        format: 'sarif'
        output: 'trivy-results-py${{ matrix.python-version }}.sarif'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-py${{ matrix.python-version }}.sarif'

    - name: Run Dockerfile security scan with Hadolint (once)
      if: matrix.scan-level == 'full'
      uses: hadolint/hadolint-action@v3.3.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-dockerfile.sarif
        no-fail: true

    - name: Upload Hadolint results
      if: matrix.scan-level == 'full'
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: hadolint-dockerfile.sarif

    - name: Upload container security reports
      uses: actions/upload-artifact@v6.0.0
      if: always()
      with:
        name: container-security-reports-py${{ matrix.python-version }}
        path: |
          trivy-results-py${{ matrix.python-version }}.sarif
          hadolint-dockerfile.sarif
        retention-days: 30

  container-manifest:
    name: Create Multi-Architecture Manifests
    runs-on: ubuntu-latest
    needs: [config, container-build]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event_name == 'release')

    permissions:
      contents: read
      packages: write

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ needs.config.outputs.container-registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create primary tag manifests
      env:
        REGISTRY: ${{ needs.config.outputs.container-registry }}
        IMAGE: ${{ needs.config.outputs.container-image }}
        VERSION: ${{ needs.config.outputs.package-version }}
        DEFAULT_PYTHON: ${{ needs.config.outputs.default-python-version }}
        PRIMARY_TAGS: ${{ needs.config.outputs.primary-tags }}
        PYTHON_TAGS: ${{ needs.config.outputs.python-tags }}
      run: |
        # Create primary tags (latest, X.Y.Z) -> point to default Python
        if [[ -n "$PRIMARY_TAGS" ]]; then
          IFS=',' read -ra TAGS <<< "$PRIMARY_TAGS"
          for tag in "${TAGS[@]}"; do
            echo "Creating primary tag: $tag -> $VERSION-python$DEFAULT_PYTHON"
            docker buildx imagetools create \
              -t "$REGISTRY/$IMAGE:$tag" \
              "$REGISTRY/$IMAGE:$VERSION-python$DEFAULT_PYTHON"
          done
        fi
        
        # Create Python variant tags (pythonX.Y) -> point to specific Python latest
        if [[ -n "$PYTHON_TAGS" ]]; then
          IFS=',' read -ra TAGS <<< "$PYTHON_TAGS"
          for tag in "${TAGS[@]}"; do
            py_ver=${tag#python}
            echo "Creating Python variant tag: $tag -> $VERSION-python$py_ver"
            docker buildx imagetools create \
              -t "$REGISTRY/$IMAGE:$tag" \
              "$REGISTRY/$IMAGE:$VERSION-python$py_ver"
          done
        fi

  container-validation:
    name: Validate Container Tags
    runs-on: ubuntu-latest
    needs: [config, container-manifest]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event_name == 'release')

    permissions:
      contents: read

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ needs.config.outputs.container-registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Test primary tags
      env:
        REGISTRY: ${{ needs.config.outputs.container-registry }}
        IMAGE: ${{ needs.config.outputs.container-image }}
        PRIMARY_TAGS: ${{ needs.config.outputs.primary-tags }}
        PYTHON_TAGS: ${{ needs.config.outputs.python-tags }}
      run: |
        # Test primary tags can be pulled and work
        if [[ -n "$PRIMARY_TAGS" ]]; then
          IFS=',' read -ra TAGS <<< "$PRIMARY_TAGS"
          for tag in "${TAGS[@]}"; do
            echo "Testing primary tag: $tag"
            docker pull "$REGISTRY/$IMAGE:$tag"
            docker run --rm "$REGISTRY/$IMAGE:$tag" version
            echo "Primary tag $tag works"
          done
        fi
        
        # Test Python variant tags
        if [[ -n "$PYTHON_TAGS" ]]; then
          IFS=',' read -ra TAGS <<< "$PYTHON_TAGS"
          for tag in "${TAGS[@]}"; do
            echo "Testing Python variant tag: $tag"
            docker pull "$REGISTRY/$IMAGE:$tag"
            docker run --rm "$REGISTRY/$IMAGE:$tag" version
            echo "Python variant tag $tag works"
          done
        fi

    - name: Test multi-architecture support
      env:
        REGISTRY: ${{ needs.config.outputs.container-registry }}
        IMAGE: ${{ needs.config.outputs.container-image }}
        VERSION: ${{ needs.config.outputs.package-version }}
        DEFAULT_PYTHON: ${{ needs.config.outputs.default-python-version }}
      run: |
        # Test that multi-arch manifests exist
        echo "Testing multi-arch manifest for $VERSION-python$DEFAULT_PYTHON"
        docker manifest inspect "$REGISTRY/$IMAGE:$VERSION-python$DEFAULT_PYTHON"
        
        # Verify both amd64 and arm64 are present
        if docker manifest inspect "$REGISTRY/$IMAGE:$VERSION-python$DEFAULT_PYTHON" | grep -q "amd64" && \
           docker manifest inspect "$REGISTRY/$IMAGE:$VERSION-python$DEFAULT_PYTHON" | grep -q "arm64"; then
          echo "Multi-arch manifest contains both amd64 and arm64"
        else
          echo "Multi-arch manifest missing architectures"
          exit 1
        fi

  container-cleanup:
    name: Cleanup Old Container Images
    runs-on: ubuntu-latest
    needs: [config, container-validation]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event_name == 'release')

    permissions:
      contents: read
      packages: write

    steps:
    - name: Delete old untagged container images (keep 5 most recent)
      uses: actions/delete-package-versions@v5
      continue-on-error: true
      with:
        package-name: ${{ needs.config.outputs.container-image }}
        package-type: container
        min-versions-to-keep: 5
        delete-only-untagged-versions: true

    - name: Delete old tagged versions (preserve releases and special tags)
      uses: actions/delete-package-versions@v5
      continue-on-error: true
      with:
        package-name: ${{ needs.config.outputs.container-image }}
        package-type: container
        min-versions-to-keep: 5
        ignore-versions: '^(latest|main|dev|develop|python.*|v?\d+\.\d+\.\d+.*)$'
