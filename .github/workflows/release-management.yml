name: Release Management

on:
  schedule:
    - cron: '0 5 * * *'    # Daily alpha suggestions (5 AM UTC)
    - cron: '0 6 * * 1'    # Weekly beta suggestions (6 AM UTC Mondays)
    - cron: '0 11 * * 3'   # Weekly RC suggestions (11 AM UTC Wednesdays)
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      action:
        description: 'Management action'
        required: true
        default: 'suggest-alpha'
        type: choice
        options:
        - suggest-alpha
        - suggest-beta
        - suggest-rc
        - analyze-rc

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  manage-releases:
    name: Release Management
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: '3.11'

      - name: Determine action
        id: action
        env:
          EVENT_NAME: ${{ github.event_name }}
          SCHEDULE: ${{ github.event.schedule }}
          INPUT_ACTION: ${{ inputs.action }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [ "$EVENT_NAME" = "schedule" ]; then
            case "$SCHEDULE" in
              "0 5 * * *") echo "action=suggest-alpha" >> "$GITHUB_OUTPUT" ;;
              "0 6 * * 1") echo "action=suggest-beta" >> "$GITHUB_OUTPUT" ;;
              "0 11 * * 3") echo "action=suggest-rc" >> "$GITHUB_OUTPUT" ;;
            esac
          elif [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "action=$INPUT_ACTION" >> "$GITHUB_OUTPUT"
          elif [ "$EVENT_NAME" = "issue_comment" ]; then
            if echo "$COMMENT_BODY" | grep -q "/release-beta"; then
              echo "action=create-beta" >> "$GITHUB_OUTPUT"
            elif echo "$COMMENT_BODY" | grep -q "/release-rc"; then
              echo "action=create-rc" >> "$GITHUB_OUTPUT"
            else
              echo "action=none" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Handle release management
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTION: ${{ steps.action.outputs.action }}
        run: |
          case "$ACTION" in
            suggest-alpha)
              echo "Checking for alpha release suggestions..."
              if [ -f ".github/workflows/auto-release-alpha.yml" ]; then
                echo "Legacy alpha workflow still exists, using that for now"
              else
                echo "Would suggest alpha release based on recent commits"
              fi
              ;;
            suggest-beta)
              echo "Checking for beta release suggestions..."
              if [ -f ".github/workflows/auto-release-beta.yml" ]; then
                echo "Legacy beta workflow still exists, using that for now"
              else
                echo "Would suggest beta release based on alpha stability"
              fi
              ;;
            suggest-rc|analyze-rc)
              echo "Running RC readiness analysis..."
              RELEASE_MODE=analysis ./dev-tools/release/orchestrator.sh || true
              ;;
            create-beta)
              echo "Creating beta release via semantic-release..."
              echo "Beta release creation not yet implemented"
              ;;
            create-rc)
              echo "Creating RC release via semantic-release..."
              echo "RC release creation not yet implemented"
              ;;
            none|*)
              echo "No action required"
              ;;
          esac
