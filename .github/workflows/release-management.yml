name: Release Management

on:
  schedule:
    - cron: '0 5 * * *'    # Daily alpha suggestions (5 AM UTC)
    - cron: '0 6 * * 1'    # Weekly beta suggestions (6 AM UTC Mondays)
    - cron: '0 11 * * 3'   # Weekly RC suggestions (11 AM UTC Wednesdays)
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      action:
        description: 'Management action'
        required: true
        default: 'suggest-alpha'
        type: choice
        options:
        - suggest-alpha
        - suggest-beta
        - suggest-rc
        - analyze-rc

permissions:
  contents: write  # Need write to create tags and releases
  issues: write
  pull-requests: write

jobs:
  manage-releases:
    name: Release Management
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: '3.11'

      - name: Determine action
        id: action
        env:
          EVENT_NAME: ${{ github.event_name }}
          SCHEDULE: ${{ github.event.schedule }}
          INPUT_ACTION: ${{ inputs.action }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [ "$EVENT_NAME" = "schedule" ]; then
            case "$SCHEDULE" in
              "0 5 * * *") echo "action=suggest-alpha" >> "$GITHUB_OUTPUT" ;;
              "0 6 * * 1") echo "action=suggest-beta" >> "$GITHUB_OUTPUT" ;;
              "0 11 * * 3") echo "action=suggest-rc" >> "$GITHUB_OUTPUT" ;;
            esac
          elif [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "action=$INPUT_ACTION" >> "$GITHUB_OUTPUT"
          elif [ "$EVENT_NAME" = "issue_comment" ]; then
            if echo "$COMMENT_BODY" | grep -q "/release-beta"; then
              echo "action=create-beta" >> "$GITHUB_OUTPUT"
            elif echo "$COMMENT_BODY" | grep -q "/release-rc"; then
              echo "action=create-rc" >> "$GITHUB_OUTPUT"
            else
              echo "action=none" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Handle release management
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTION: ${{ steps.action.outputs.action }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          case "$ACTION" in
            suggest-alpha)
              make release-alpha-if-needed
              ;;
            suggest-beta)
              make release-beta-if-needed
              ;;
            suggest-rc|analyze-rc)
              make release-rc-if-needed
              ;;
            create-beta)
              make release-patch-beta
              ;;
            create-rc)
              make release-patch-rc
              ;;
            none|*)
              echo "No action required"
              ;;
          esac
