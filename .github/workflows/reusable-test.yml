name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      test-type:
        description: 'Type of tests to run (unit, integration, e2e, performance)'
        required: true
        type: string
      python-version:
        description: 'Python version to test with'
        required: false
        type: string
      default-python-version:
        description: 'Default Python version (fallback)'
        required: false
        type: string
        default: '3.13'
      os:
        description: 'Operating system to run on'
        required: false
        type: string
        default: 'ubuntu-latest'
      continue-on-error:
        description: 'Whether to continue on test failures'
        required: false
        type: boolean
        default: false
      upload-coverage:
        description: 'Whether to upload coverage reports'
        required: false
        type: boolean
        default: true

env:
  AWS_DEFAULT_REGION: us-east-1
  AWS_ACCESS_KEY_ID: testing
  AWS_SECRET_ACCESS_KEY: testing
  ENVIRONMENT: testing
  TESTING: true

jobs:
  test:
    name: ${{ inputs.test-type == 'unit' && 'Unit Tests' || inputs.test-type == 'integration' && 'Integration Tests' || inputs.test-type == 'e2e' && 'End-to-End Tests' || format('{0} Tests', inputs.test-type) }}
    runs-on: ${{ inputs.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup UV with cached environment
        uses: ./.github/actions/setup-uv-cached
        with:
          cache-key: deps-${{ inputs.python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml.template', 'requirements*.txt') }}
          fail-on-cache-miss: false

      - name: Run tests
        run: make ci-tests-${{ inputs.test-type }}
        continue-on-error: ${{ inputs.continue-on-error }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ inputs.test-type }}-test-results-${{ inputs.os }}-${{ inputs.python-version || inputs.default-python-version }}
          path: |
            junit-*.xml
            coverage-*.xml

      - name: Upload coverage to Codecov
        if: inputs.upload-coverage && always()
        uses: codecov/codecov-action@v5
        with:
          files: coverage-${{ inputs.test-type }}.xml
          flags: ${{ inputs.test-type }}
          name: ${{ inputs.test-type }}-tests
