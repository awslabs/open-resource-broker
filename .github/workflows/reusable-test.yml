name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      test-type:
        description: 'Type of tests to run (unit, integration, e2e, performance)'
        required: true
        type: string
      python-version:
        description: 'Python version to test with'
        required: false
        type: string
      default-python-version:
        description: 'Default Python version (fallback)'
        required: true
        type: string
      os:
        description: 'Operating system to run on'
        required: false
        type: string
        default: 'ubuntu-latest'
      continue-on-error:
        description: 'Whether to continue on test failures'
        required: false
        type: boolean
        default: false
      upload-coverage:
        description: 'Whether to upload coverage reports'
        required: false
        type: boolean
        default: true
      aws-region:
        description: 'AWS region for testing'
        required: false
        type: string
        default: 'us-east-1'
      aws-access-key:
        description: 'AWS access key for testing'
        required: false
        type: string
        default: 'testing'
      aws-secret-key:
        description: 'AWS secret key for testing'
        required: false
        type: string
        default: 'testing'
      environment:
        description: 'Environment name'
        required: false
        type: string
        default: 'testing'
      testing-flag:
        description: 'Testing flag'
        required: false
        type: string
        default: 'true'

env:
  AWS_DEFAULT_REGION: ${{ inputs.aws-region }}
  AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key }}
  AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-key }}
  ENVIRONMENT: ${{ inputs.environment }}
  TESTING: ${{ inputs.testing-flag }}

jobs:
  test:
    name: ${{ inputs.test-type == 'unit' && 'Unit Tests' || inputs.test-type == 'integration' && 'Integration Tests' || inputs.test-type == 'e2e' && 'End-to-End Tests' || format('{0} Tests', inputs.test-type) }}
    runs-on: ${{ inputs.os }}
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Setup UV with cached environment
        uses: ./.github/actions/setup-uv-cached
        with:
          cache-key: deps-${{ inputs.python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml', 'requirements*.txt') }}
          fail-on-cache-miss: false

      - name: Run tests
        run: make ci-tests-${{ inputs.test-type }}
        continue-on-error: ${{ inputs.continue-on-error }}

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-${{ inputs.test-type }}-${{ inputs.os }}-py${{ inputs.python-version || inputs.default-python-version }}
          retention-days: 30
          path: |
            junit-*.xml
            coverage-*.xml

      - name: Upload coverage to Codecov
        if: inputs.upload-coverage && always()
        uses: codecov/codecov-action@v5
        with:
          files: coverage-${{ inputs.test-type }}.xml
          flags: ${{ inputs.test-type }}
          name: ${{ inputs.test-type }}-tests
