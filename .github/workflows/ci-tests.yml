name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'

env:
  AWS_DEFAULT_REGION: us-east-1
  AWS_ACCESS_KEY_ID: testing
  AWS_SECRET_ACCESS_KEY: testing
  ENVIRONMENT: testing
  TESTING: true

jobs:
  config:
    name: Configuration
    uses: ./.github/workflows/shared-config.yml

  tests:
    name: Run Tests
    needs: config
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
      fail-fast: false
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: ${{ matrix.test-type }}
      python-version: ${{ needs.config.outputs.default-python-version }}
      default-python-version: ${{ needs.config.outputs.default-python-version }}
      continue-on-error: true

  performance-tests:
    name: Performance Tests
    needs: config
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: performance
      python-version: ${{ needs.config.outputs.default-python-version }}
      default-python-version: ${{ needs.config.outputs.default-python-version }}
      continue-on-error: true

  build-and-package:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: config
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v6.0.1

    - name: Setup UV with cached environment
      uses: ./.github/actions/setup-uv-cached
      with:
        cache-key: deps-${{ needs.config.outputs.default-python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml', 'requirements*.txt') }}
        fail-on-cache-miss: false

    - name: Build package
      run: make build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v6.0.0
      with:
        name: build-artifacts
        path: |
          dist/
          build/

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [config, tests]
    if: always()
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v6.0.1

    - name: Setup UV with cached environment
      uses: ./.github/actions/setup-uv-cached
      with:
        cache-key: deps-${{ needs.config.outputs.default-python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml', 'requirements*.txt') }}
        fail-on-cache-miss: false

    - name: Download all test results
      uses: actions/download-artifact@v7.0.0
      with:
        path: test-results/

    - name: Generate complete test report
      run: make test-report
      continue-on-error: true

    - name: Upload complete test report
      uses: actions/upload-artifact@v6.0.0
      if: always()
      with:
        name: complete-test-report
        path: |
          test-results-combined.xml
          coverage-combined.xml
          htmlcov/

    - name: Upload final coverage to Codecov
      uses: codecov/codecov-action@v5
      if: always()
      with:
        files: coverage-combined.xml
        flags: complete
        name: complete-tests
