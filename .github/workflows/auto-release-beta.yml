name: Weekly Beta Release Suggestion

on:
  schedule:
    - cron: '0 6 * * 1'  # 6 AM UTC Mondays
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read
  issues: write

jobs:
  suggest-beta:
    name: Suggest Beta Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history for git log analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: '3.11'

      - name: Check for changes since last beta
        id: check-changes
        run: |
          # Get the latest beta tag
          LATEST_BETA=$(git tag -l "v*beta*" --sort=-version:refname | head -1)
          
          if [ -n "$LATEST_BETA" ]; then
            CHANGES=$(git log "${LATEST_BETA}..HEAD" --oneline | wc -l)
            echo "Latest beta: $LATEST_BETA"
            echo "Changes since last beta: $CHANGES"
            
            if [ "$CHANGES" -gt 0 ]; then
              {
                echo "should_suggest=true"
                echo "changes_count=$CHANGES"
                echo "since_tag=$LATEST_BETA"
              } >> "$GITHUB_OUTPUT"
            else
              echo "should_suggest=false" >> "$GITHUB_OUTPUT"
            fi
          else
            # No beta releases yet, check for any changes
            CHANGES=$(git log --since='7 days ago' --oneline | wc -l)
            echo "No previous beta releases found"
            echo "Changes in last 7 days: $CHANGES"
            
            if [ "$CHANGES" -gt 0 ]; then
              {
                echo "should_suggest=true"
                echo "changes_count=$CHANGES"
                echo "since_tag=initial"
              } >> "$GITHUB_OUTPUT"
            else
              echo "should_suggest=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Create beta release suggestion issue
        if: steps.check-changes.outputs.should_suggest == 'true'
        run: |
          ISSUE_TITLE="Weekly Beta Release - $(date +%Y-%m-%d)"
          CHANGES_COUNT="${{ steps.check-changes.outputs.changes_count }}"
          SINCE_TAG="${{ steps.check-changes.outputs.since_tag }}"
          
          # Create issue body
          {
            echo "## Weekly Beta Release Suggestion"
            echo ""
            echo "Changes detected: $CHANGES_COUNT commits since $SINCE_TAG"
            echo ""
            echo "### Recent Changes"
            echo '```'
            git log --oneline --max-count=10 "${SINCE_TAG}..HEAD" 2>/dev/null || git log --oneline --max-count=10 --since='7 days ago'
            echo '```'
            echo ""
            echo "### Actions"
            echo "- To create beta release: Comment \`/release-beta\` on this issue"
            echo "- To skip this week: Close this issue without comment"
            echo ""
            echo "### Release Process"
            echo "1. Comment \`/release-beta\` triggers automated beta release"
            echo "2. GitHub release created with release notes"
            echo "3. Changelog PR created for review and merge"
            echo "4. Issue automatically closed after successful release"
            echo ""
            echo "---"
            echo "This issue was created automatically by the weekly beta release workflow."
          } > issue_body.md
          
          gh issue create \
            --title "$ISSUE_TITLE" \
            --body-file issue_body.md \
            --label "release,beta,weekly,automated"

      - name: Report status
        run: |
          if [ "${{ steps.check-changes.outputs.should_suggest }}" = "true" ]; then
            echo "Beta release suggestion issue created"
            echo "Changes: ${{ steps.check-changes.outputs.changes_count }} commits"
          else
            echo "No beta release needed (no changes since last beta)"
          fi
