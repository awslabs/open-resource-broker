name: Auto Release Stable

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release creation'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: read

jobs:
  get-config:
    name: Get Configuration
    runs-on: ubuntu-latest
    outputs:
      default-python-version: ${{ steps.config.outputs.default-python-version }}
      package-version: ${{ steps.config.outputs.package-version }}
      is-release: ${{ steps.config.outputs.is-release }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Get project configuration
      id: config
      uses: ./.github/actions/get-config

  check-stable-version:
    name: Check for Stable Version
    runs-on: ubuntu-latest
    needs: get-config
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      version-type: ${{ steps.check.outputs.version-type }}
    
    steps:
      - name: Check version pattern
        id: check
        run: |
          VERSION="${{ needs.get-config.outputs.package-version }}"
          echo "Current version: $VERSION"
          
          # Check if version is stable (no alpha, beta, rc suffixes)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Stable version detected: $VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "version-type=stable" >> "$GITHUB_OUTPUT"
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(rc|beta)[0-9]+$ ]]; then
            echo "Pre-release version: $VERSION"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "version-type=pre-release" >> "$GITHUB_OUTPUT"
          else
            echo "Development version: $VERSION"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "version-type=development" >> "$GITHUB_OUTPUT"
          fi

  create-stable-release:
    name: Create Stable Release
    runs-on: ubuntu-latest
    needs: [get-config, check-stable-version]
    if: |
      (needs.check-stable-version.outputs.should-release == 'true' || github.event.inputs.force_release == 'true') &&
      github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python and UV
        uses: ./.github/actions/setup-uv-cached
        with:
          cache-key: deps-${{ needs.get-config.outputs.default-python-version }}-${{ hashFiles('.project.yml', 'pyproject.toml', 'requirements*.txt') }}
          fail-on-cache-miss: false

      - name: Check if release already exists
        id: release-check
        run: |
          VERSION="${{ needs.get-config.outputs.package-version }}"
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "Release v$VERSION already exists"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Release v$VERSION does not exist"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        if: steps.release-check.outputs.exists == 'false'
        run: |
          VERSION="${{ needs.get-config.outputs.package-version }}"
          make release-notes-generate
          echo "Generated release notes for v$VERSION"

      - name: Create GitHub release
        if: steps.release-check.outputs.exists == 'false'
        run: |
          VERSION="${{ needs.get-config.outputs.package-version }}"
          
          gh release create "v$VERSION" \
            --title "Release $VERSION" \
            --notes-file "release-notes-v$VERSION.md" \
            --latest
          
          echo "Created release: v$VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ needs.get-config.outputs.package-version }}"
          if [[ "${{ steps.release-check.outputs.exists }}" == "true" ]]; then
            echo "Release v$VERSION already exists"
          else
            echo "Created release v$VERSION"
          fi
